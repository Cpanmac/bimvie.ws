<div class="query2">
	<form>
		<div class="form-group">
			<select class="form-control">
				<option>Select a query or create your own</option>
			</select>
		</div>
		<div class="form-group">
			<textarea class="form-control" rows="20"></textarea>
		</div>
		<div class="form-group">
			<button class="btn btn-primary querySetBtn">Query Set</button>
			<button class="btn btn-primary queryAddBtn">Query Add</button>
			<button class="btn btn-primary downloadBtn">Download</button>
		</div>
	</form>
</div>
<script>
function Query2(cd, parent) {
	var o = this;
	o.roids = [];
	
	var queries = {
		AllObjects: {
			IfcProduct: {}
		},
		AllWalls: {
			IfcWall: {}
		},
		AllWallsIncludingDecomposition: {
			IfcWall: {
				includes: ["validifc:ContainedInStructure", "validifc:OwnerHistory", "validifc:Representation", "validifc:ObjectPlacement"]
			}
		},
		AllWallsIncludingWindowsAndDoors: {
			IfcWall: {
				HasOpenings: {
					RelatedOpeningElement: {
						"IfcOpeningElement.HasFillings": {
							RelatedBuildingElement: {
								
							}
						}
					}
				}
			}
		},
		AllWallsIncludingWindows: {
			IfcWall: {
				HasOpenings: {
					RelatedOpeningElement: {
						"IfcOpeningElement.HasFillings": {
							RelatedBuildingElement: {
								IfcWindow: {
									
								}
							}
						}
					}
				}
			}
		},
		AllWallsAndSlabs: {
			types: ["IfcWall", "IfcSlab"]
		},
		SpecificWallsByGuid: {
			IfcWall: {
				where: {
					guids: ["2udBPbKibCZ8zbfpJmtDTM", "2V1MCFZRf1GA2ZyRufjYwX", "2oOoWKmmfChQTLCBzuB3$b"]
				}
			}
		},
		SpecificBuildingStoreyIncContains: {
			IfcBuildingStorey: {
				where: {
					guid: "25SMdCQszBi9al8gnrh8LV"
				},
				ContainsElements: {
					RelatedElements: {
						
					}
				}
			}
		},
		SpecificBuildingStoreyIncContainsExcludeSelf: {
			IfcBuildingStorey: {
				include: false,
				where: {
					guid: "25SMdCQszBi9al8gnrh8LV"
				},
				ContainsElements: {
					include: false,
					RelatedElements: {
					}
				}
			}
		},
		ExternalWalls: {
			IfcWall: {
				where: {
					properties: {
						IsExternal: true
					}
				}
			}
		},
		ThermalTransmittance: {
			IfcWall: {
				where: {
					properties: {
						ThermalTransmittance: {
							comparator: ">",
							value: 0.2
						}
					}
				}				
			}
		},
		IfcPresentationLayerAssignment: {
			IfcPresentationLayerAssignment: {
				where: {
					name: "Räume",
				},
				AssignedItems: {}
			}
		},
		ObjectInBoundingBox: {
			IfcFurnishingElement: {
				where: {
					inBoundingBox: {
						x: 0,
						y: 0,
						z: 0,
						width: 5,
						height: 5,
						depth: 5
					}
				}
			}
		},
		Classification: {
			IfcClassificationReference: {
				where: {
					field: {
						Name: "Büroarbeit"
					}
				},
				incoming: {
					outfield: "RelatingClassification",
					type: "IfcRelAssociatesClassification",
					follow: "RelatedObjects"
				}
			}
		},
		Test: {
			type: "IfcWall",
			where: {
				and: [{
					field: {
						Name: "Büroarbeit"
					}
				}, {
					property: {
						ThermalTransmittance: 0.2
					}
				}]
			}
		}
	};
	
	for (var queryKey in queries) {
	    if (queries.hasOwnProperty(queryKey)) {
	    	var option = $("<option>" + queryKey + "</option>");
	    	cd.find("select").append(option);
	    }
	}
	
	this.show = function(){
		cd.show();
	};
	
	this.hide = function(){
		cd.hide();
	};
	
	cd.find("select").change(function(){
		var query = queries[cd.find("select").val()];
		var json = JSON.stringify(query, null, "  ");
		cd.find("textarea").val(json);
	});
	
	this.addRevision = function(project, roid, types){
		o.roids.push(roid);
	};
	
	this.loadRevision = function(project, roid, types) {
	};
	
	this.unloadRevision = function(poid, roid) {
	};
	
	cd.find(".queryAddBtn").click(function(e){
		e.preventDefault();
		o.roids.forEach(function(roid){
			var model = parent.models[roid];
			if (model != null) {
				model.reset();
				var oids = [];
				model.queryNew(JSON.parse(cd.find("textarea").val()), function(loaded){
					if (loaded.getType() != "IfcOpeningElement") {
						oids.push(loaded.oid);
						loaded.trans.mode = 0;
					}
				}).done(function(){
					parent.setObjectVisibility(roid, oids, 0);
				});
			}
		});
	});

	cd.find(".downloadBtn").click(function(e){
		e.preventDefault();
		var div = $("<div class=\"modal fade\">");
		$(document.body).append(div);
		var params = {
			downloadType: "downloadByNewJsonQuery",
			allowCheckouts: false,
			query: cd.find("textarea").val(),
			roids: o.roids
		};
		div.load(Global.baseDir + "download.html", function(){
			new Download($(this), params);
		}).modal("show");
	});
	
	cd.find(".querySetBtn").click(function(e){
		e.preventDefault();
		o.roids.forEach(function(roid){
			var model = parent.models[roid];
			var oids = [];
			for (var oid in model.objects) {
				oids.push(oid);
			}
			if (oids.length > 0) {
				parent.setObjectVisibility(roid, oids, 2);
			}
			if (model != null) {
				model.reset();
				var oids = [];
				model.queryNew(JSON.parse(cd.find("textarea").val()), function(loaded){
					if (loaded.getType() != "IfcOpeningElement") {
						oids.push(loaded.oid);
					}
				}).done(function(){
					parent.setObjectVisibility(roid, oids, 0);
				});
			}
		});
	});

	parent.modelAddedListeners.register(o.addRevision);
	parent.modelLoadedListeners.register(o.loadRevision);
	parent.modelUnloadedListeners.register(o.unloadRevision);
}
</script>