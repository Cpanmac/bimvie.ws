<div class="projects">
	<div class="buttonBar well well-sm initialhide">
		<button class="addProjectButton btn btn-default initialhide">Add project</button>
	</div>
	<div class="well well-sm noprojects">There are no projects yet</div>
	<table class="projectsTable initialhide table table-striped table-hover initialhide">
		<thead>
			<tr>
				<th>Name</th>
				<th>Sub Projects</th>
				<th>Revisions</th>
				<th>Actions</th>
			</tr>
		</thead>
		<tbody>
		</tbody>
	</table>
</div>
<script>
function Projects(containerDiv, main) {
	var othis = this;

	this.projectClick = function(event) {
		if (!$(event.target).is("a, button, span.caret")) {
			main.showProject($(this).parents("tr").andSelf().data("project"), null, true);
			othis.close();
		}
	};

	this.close = function() {
		Global.bimServerApi.unregisterNewProjectHandler(othis.newProjectHandler);
	};

	this.show = function() {
		Global.bimServerApi.registerNewProjectHandler(othis.newProjectHandler);
	};
	
	this.deleteProject = function(project){
		Global.bimServerApi.callWithFullIndication("Bimsie1ServiceInterface", "deleteProject", {poid: project.oid}, function(){
			othis.loadProjects();
		});
	};
	
	this.undeleteProject = function(project){
		Global.bimServerApi.callWithFullIndication("Bimsie1ServiceInterface", "undeleteProject", {poid: project.oid}, function(){
			othis.loadProjects();
		});
	};
	
	this.addProject = function(project, parent, indent) {
		$(".projects .projectsTable").show();
		$(".projects .noprojects").hide();
		var projectRow = $("<tr>");
		projectRow.attr("poid", project.oid);
		projectRow.data("project", project);
		projectRow.click(othis.projectClick);

		var add = "";
		if (indent != null) {
			for (var i=0; i<indent; i++) {
				add += "&nbsp;&nbsp;&nbsp;&nbsp;";
			}
			add += project.name;
		} else {
			add += "<b>" + project.name + "</b>";
		}
		projectRow.append("<td>" + add + "</td>");

		projectRow.append("<td>" + project.subProjects.length + "</td>");
		projectRow.append("<td>" + project.revisions.length + "</td>");
		var actions = newDropdownTd("Actions");

		actions.find(".dropdown-toggle").click(function(){
			actions.find("ul li").remove();
			var project = $(this).parents("tr").data("project");
			if (project.state == "ACTIVE") {
				var li = $("<li><a>Delete</a></li>");
				li.find("a").click(function(){othis.deleteProject(project)});
				actions.find("ul").append(li);
			} else {
				var li = $("<li><a>Undelete</a></li>");
				li.find("a").click(function(){othis.undeleteProject(project)});
				actions.find("ul").append(li);
			}
		});

		Global.bimServerApi.call("ServiceInterface", "userHasCheckinRights", {uoid: main.user.oid, poid: project.oid}, function(canCheckin){
			if (canCheckin) {
				projectRow.addClass("success");
			} else {
				projectRow.addClass("warning");
			}
		});
		
		projectRow.append(actions);

		project.subProjects.forEach(function(subProjectOid){
			Global.bimServerApi.call("Bimsie1ServiceInterface", "getProjectByPoid", {poid: subProjectOid}, function(subProject){
				othis.addProject(subProject, project, indent == null ? 1 : (indent + 1));
			});
		});
		
		if (parent != null) {
			$(".projectsTable [poid=" + parent.oid + "]").after(projectRow);
		} else {
			$(".projectsTable").append(projectRow);
		}
	};
	
	this.loadProjects = function(){
		Global.bimServerApi.call("SettingsInterface", "isAllowUsersToCreateTopLevelProjects", {}, function(enabled){
			if (main.user.userType == "ADMIN" || enabled) {
				$(".buttonBar").show();
				$(".addProjectButton").show();
			}
		});
		
		$(".projectsTable tbody tr").remove();
		Global.bimServerApi.call("Bimsie1ServiceInterface", "getAllProjects", {onlyTopLevel: true, onlyActive: true}, function(data){
			data.forEach(function(project){
				othis.addProject(project);
			});
			$(".projectsTable").show();
		});
	};
	
	this.newProjectHandler = function(poid){
		Global.bimServerApi.call("Bimsie1ServiceInterface", "getProjectByPoid", {poid: poid}, function(data){
			othis.addProject(data);
		});
	};
	
	$(".addProjectButton").click(function(){main.showAddProject()});

	othis.loadProjects();
}
</script>