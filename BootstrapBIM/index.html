<!DOCTYPE html>
<html>
  <head>
	<meta content="text/html;charset=utf-8" http-equiv="Content-Type">
	<meta content="utf-8" http-equiv="encoding">    <title>BIMserver Demo</title>
    <link href="css/bootstrap.min.css" rel="stylesheet">
    <link href="css/main.css" rel="stylesheet">
	<link rel="shortcut icon" type="image/ico" href="img/logo_small.png"/>
    <script src="js/jquery-1.8.2.min.js"></script>
    <script src="js/bootstrap.min.js"></script>
    <script src="js/String.js"></script>
    <script src="js/utils.js"></script>
    <script src="js/main.js"></script>
    <script src="js/jquery.ui.widget.js"></script>
    <script src="js/jquery.history.js"></script>
    <script src="js/jquery.numeric.js"></script>
    <script src="js/jquery.iframe.transport.js"></script>
    <script src="js/jquery.fileupload.js"></script>
    <script src="js/jquery.enterpress.js"></script>
    <script src="js/formatters.js"></script>
    <script src="js/jquery.cookie.js"></script>
    <script src="js/sha256.js"></script>
    <script src="js/scenejs.js"></script>
    <script src="js/scenejs.math.extra.js"></script>
    <script src="js/scenejs.math.js"></script>
    <script src="js/scenejs.viewer.js"></script>  </head>
  <body>
	<div class="alert fade in genericErrors" id="login-error" style="display:none;">
		<span class="text"></span>
		<button type="button" class="close">Ã—</button>
	</div>
	<div class="statusholder">
		<div class="status well well-small"></div>
	</div>
	<div class="indexcontainer container-fluid"></div>
	<script>
		var bimServerApi;
		var objectcache = {};
		
		pushInitialState();
		
		$(".status").hide();
		
		var notifier = {
			error: function(message){
				$(".genericErrors .text").html(message).parent().show();
			},
			info: function(message) {
				$(".genericErrors .text").html(message).parent().show();						
			},
			clear: function() {
				$(".genericErrors .text").html("").parent().hide();
			},
			resetStatus: function(){
				$(".status").stop(true, true);
				$(".status").fadeOut(1000);
			},
			resetStatusQuick: function(){
				$(".status").hide();
			},
			setStatus: function(status, timeToShow) {
				if (timeToShow == null) {
					timeToShow = 5000;
				}
				$(".status").stop(true, true);
				if (this.lastTimeOut != null) {
					clearTimeout(this.lastTimeOut);
					this.lastTimeOut = null;
				}
				$(".status").show().html(status).removeClass("error");
				var notifier = this;
				if (timeToShow != -1) {
					this.lastTimeOut = setTimeout(function(){
						notifier.resetStatus();
					}, timeToShow);
				}
			},
			setError: function(error) {
				$(".status").html(error).addClass("error").show();
			}
		};

		function loadError() {
			window.clearTimeout(timeoutId);
			notifier.error("Could not connect");
			$.removeCookie("username");
			$.removeCookie("autologin");
			$.removeCookie("address");
			$(".indexcontainer").load("login.html", function(){
				new Login();
			});
		}
		
		var timeoutId; // timeout id is a global variable
		$(function(){
			if ($.cookie("autologin") != null) {
				timeoutId = window.setTimeout(function() {
					loadError();
				}, 3000);
				$.getScript($.cookie("address") + "/js/bimserverapi.js")
				.done(function(script, textStatus) {
					window.clearTimeout(timeoutId);
					bimServerApi = new BimServerApi($.cookie("address"), notifier);
					bimServerApi.autologin($.cookie("username"), $.cookie("autologin"), function(){
						$(".indexcontainer").load("main.html", function(){
							new Main($.cookie("address"), $.cookie("username")).show(false);
						});
					}, function(){
						$(".indexcontainer").load("login.html", function(){
							new Login();
						});
					});
				}).fail(function(jqxhr, settings, exception){
					loadError();
				});
			} else {
				$(".indexcontainer").load("login.html", function(){
					new Login();
				});
			}
			
			setInterval(function() {
				var now = new Date().getTime();
				$(".timespan").each(function() {
					$(this).html(formatTimeSpan(now - $(this).attr("datetime"), false));
				});
			}, 60000);
		});
	</script>
  </body>
</html>