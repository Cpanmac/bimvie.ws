<div class="testing">
	<table class="table">
		<thead>
			<tr>
				<th>Name</th>
				<th>Description</th>
				<th>Run</th>
				<th>Results</th>
			</tr>
		</thead>
		<tbody></tbody>
	</table>
</div>
<script>
function Testing() {
	var othis = this;

	this.close = function(){};
	
	this.addTest = function(name, description, test){
		var tr = $("<tr>");
		tr.append("<td>" + name + "</td>");
		tr.append("<td>" + description + "</td>");
		tr.append("<td><button class=\"btn\">Run</button></td>");
		tr.find("button").click(function(){
			var resultTd = $(this).parents("tr").find(".result");
			test(function(result){
				console.log("result", result);
				resultTd.html(result);
			});
		});
		tr.append("<td class=\"result\"></td>");
		$(".testing table tbody").append(tr);
	};

	this.addTest("Test 1", "Create furnishing + GUID", function(doneCallback){
		Global.bimServerApi.call("ServiceInterface", "addProject", {projectName: "Test 1" + Math.random()}, function(project){
			Global.bimServerApi.createModel(project.oid, function(model){
				model.create("IfcFurnishingElement", {}, function(furnishingElement){
					furnishingElement.setGlobalId("blablabla");
				});
			}).done(function(model){
				console.log("done");
				model.commit("initial revision", function(roid){
					// Now we will test and see if the objects are really there
					Global.bimServerApi.getModel(project.oid, roid, false, function(model){
						var first = true;
						model.getAllOfType("IfcFurnishingElement", true, function(furnishingElement){
							if (first) {
								first = false;
								console.log(furnishingElement);
								furnishingElement.getGlobalId(function(globallyUniqueId){
									if (globallyUniqueId == null) {
										doneCallback("Error: No GUID");
									} else if (globallyUniqueId == "blablabla") {
										doneCallback("Success");
									} else {
										doneCallback("Error: Not the right GUID value");
									}
								});
							} else {
								doneCallback("Error: Multiple IfcFurnishingElement");
							}
						});
					});
				});
			});
		});
	});

	this.addTest("Test 2", "Create 10 walls, delete 1", function(doneCallback){
		Global.bimServerApi.call("ServiceInterface", "addProject", {projectName: "Test 2" + Math.random()}, function(project){
			// Stage 1: create 10 walls
			Global.bimServerApi.createModel(project.oid, function(model){
				for (var i=1; i<=10; i++) {
					(function(i){
						model.create("IfcWall", {}, function(wall){
							wall.setName("wall " + i);
							wall.setGlobalId("wall" + i); // yes not using real GUID, this is just for testing
						});
					})(i);
				}
			}).done(function(model){
				model.commit("initial revision with 10 walls", function(roid){
					// Stage 2: count the walls and remove the 6th
					Global.bimServerApi.getModel(project.oid, roid, false, function(model){
						model.count("IfcWall", true, function(count){
							if (count == 10) {
								model.getByGuid("wall6", function(wall6){
									wall6.remove();
								});
							} else {
								doneCallback("Error: " + count + " walls found, should be 10");
							}
						});
					}).done(function(model){
						model.commit("removing the 6th wall", function(roid){
							// Stage 3: count again
							Global.bimServerApi.getModel(project.oid, roid, false, function(model){
								model.count("IfcWall", true, function(count){
									if (count == 9) {
										doneCallback("Success");
									} else {
										doneCallback("Error: Found " + count + " walls, should be 9");
									}
								});
							});			
						});
					});
				});
			});
		});
	});

	this.addTest("Test 3", "Create a wall with a window with actual geometry", function(doneCallback){
		Global.bimServerApi.call("ServiceInterface", "addProject", {projectName: "Test 3" + Math.random()}, function(project){
			Global.bimServerApi.createModel(project.oid, function(model){
				var ifcCartesianPoint = model.create("IfcCartesianPoint", {
					Coordinates: [0.0, 0.0, 0.0]
				});

				var ifcAxis2Placement = model.create("IfcAxis2Placement", {
					Location: ifcCartesianPoint
				});
				
				var ifcGeometricRepresentationContext = model.create("IfcGeometricRepresentationContext", {
					ContextType: "Model",
					CoordinateSpaceDimension: 3,
					Precision: 1.000E-5,
					WorldCoordinateSystem: ifcAxis2Placement
				});

				var ifcPerson = model.create("IfcPerson", {
					FamilyName: "de Laat",
					GivenName: "Ruben",
					PrefixTitles: "BSc"
				});
				
				var ifcPersonAndOrganization = model.create("IfcPersonAndOrganization", {
					ThePerson: ifcPerson,
					TheOrganization: ifcOrganization
				});
				
				var ifcOrganization = model.create("IfcOrganization", {
					Name: "TNO",
					Description: "TNO Building Innovation"
				});
				
				var ifcApplication = model.create("IfcApplication", {
					ApplicationDeveloper: ifcOrganization,
					Version: "1.2",
					ApplicationFullName: "BIMserver",
					ApplicationIdentifier: "BIMserver"
				});
				
				var ownerHistory = model.create("IfcOwnerHistory", {
					ChangeAction: "ADDED",
					CreationDate: 1216884646,
					OwningUser: ifcPersonAndOrganization
				})
				
				var ifcProject = model.create("IfcProject", {
					GlobalId: "2o1ykWxGT4ZxPjHNe4gayR",
					Name: "Default Project",
					Description: "Description of Default Project",
					RepresentationContexts: [ifcGeometricRepresentationContext],
					OwnerHistory: ownerHistory
				});

				var ifcUnitAssignment = model.create("IfcUnitAssignment", {});
				
				ifcUnitAssignment.getUnits().add(model.create("IfcSIUnit", {
					UnitType: "LENGTHUNIT",
					Prefix: "MILLI",
					Name: "METRE"
				}));
				ifcUnitAssignment.getUnits().add(model.create("IfcSIUnit", {
					UnitType: "AREAUNIT",
					Name: "SQUARE_METRE"
				}));
				
				var ifcDimensionalComponents = model.create("IfcDimensionalExponents");

				var ifcMeasureWithUnit = model.create("IfcMeasureWithUnit");
				
				var ifcConversionBasedUnit = model.create("IfcConversionBasedUnit", {
					Dimensions: ifcDimensionalComponents,
					UnitType: "PLANEANGLEUNIT",
					Name: "DEGREE",
					ConversionFactor: ifcMeasureWithUnit
				});
			});
		});
	});
}
</script>