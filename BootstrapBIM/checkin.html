<div class="checkin">
	<div class="modal-header">
    	<a class="close" data-dismiss="modal">&times;</a>
    	<h3>Checkin</h3>
  	</div>
	<div class="modal-body">
		<a class="uploadlink">This project has subprojects, click here if you still want to checkin a new revision</a>
		<div class="uploads">
			<div class="upload">
				<div class="uploadStatus"></div>
				<div class="progressBarHolder"></div>
				<table class="uploadTable">
				<tr><td><label for="file">File</label></td><td><input class="fileupload" type="file" name="data"/></td></tr>
				<tr><td><label for="deserializerName">Deserializer</label></td><td><select class="deserializerName" name="deserializerName">
				<option value="[NONE]">Select a deserializer</option>
				</select></td></tr>
				<tr><td><label for="comment">Comment</label></td><td><textarea class="comment" name="comment" cols="57" rows="4"></textarea></td></tr>
				<tr><td><label for="merge">Merge</label></td><td><input class="merge" name="merge" type="checkbox"/></td></tr>
				</table>
			</div>
			<div class="uploadbranch">
				<form method="post" action="branch.jsp">
					<label>Project/Revision</label> 
					<select class="revisionSelect" name="roid"></select> 
					<label>Comment</label> <input type="text" name="comment" /> 
					<input type="hidden" name="action" value="branchtoexistingproject" />
					<input type="hidden" name="destpoid" />
				</form>
				<br/>
			</div>
			<a class="showuploadlink initialhide">OR Checkin new revision</a>
			<a class="uploadbranchlink">OR Checkin existing revision</a>
		</div>
	</div>
  	<div class="modal-footer">
    	<a class="btn" data-dismiss="modal">Close</a>
    	<a class="btn uploadButton btn-primary">Checkin new revision</a>
  	</div>
</div>
<script>
var lastVal = "";

function Checkin(containerDiv, project, successFunction) {
	var othis = this;
	othis.project = project;
	
	this.hideUpload = function() {
		containerDiv.find(".uploadbranchlink").hide();			
		containerDiv.find(".uploadTable").hide();
		containerDiv.find(".uploadProgressBar").show();
		containerDiv.find(".uploadButton").hide();
		containerDiv.find(".uploadStatus").show();
	};

	this.showUpload = function() {
		containerDiv.find(".uploadbranchlink").show();			
		containerDiv.find(".uploadTable").show();
		containerDiv.find(".uploadProgressBar").hide();
		containerDiv.find(".uploadButton").show();
	};
	
	containerDiv.find(".uploadajaxloader").hide();

	Global.bimServerApi.call("ServiceInterface", "getAllDeserializers", {onlyEnabled: true}, function(data){
		data.forEach(function(deserializer){
			var option = $("<option value=\"" + deserializer.oid + "\">" + deserializer.name + "</option>");
			containerDiv.find(".deserializerName").append(option);
		});
	});

	var submitdata = null;
	var shouldsend = false;
	var currentCheckinId = null;
	var fileselected = false;

	this.progressHandler = function(topicId, state) {
		var oldStage = othis.stage;
		othis.stage = state.stage;
		if (state.state == "ERROR") {
			containerDiv.find(".uploadStatus").empty();
			state.errors.forEach(function(error){
				containerDiv.find(".uploadStatus").append("<div class=\"alert alert-block alert-error\">" + error + "</div>");
			});
			othis.showUpload();
			Global.bimServerApi.unregisterProgressHandler(topicId, othis.progressHandler);
		} else {
			containerDiv.find(".uploadStatus").html(state.title);
			if (oldStage != state.stage) {
				containerDiv.find(".progressBarHolder .uploadProgressBar").remove();
				containerDiv.find(".progressBarHolder").append("<div class=\"uploadProgressBar progress initialhide\"><div class=\"bar\"></div></div>");
			}
			if (state.progress == -1) {
				containerDiv.find(".uploadProgressBar").addClass("progress-striped").addClass("active");
				containerDiv.find(".uploadProgressBar .bar").css("width", "100%");
			} else {
				containerDiv.find(".uploadProgressBar").removeClass("progress-striped").removeClass("active");
				containerDiv.find(".uploadProgressBar .bar").css("width", parseInt(state.progress) + "%");
			}
			containerDiv.find(".progressBarHolder .uploadProgressBar").show();
			if (state.state == "FINISHED") {
				containerDiv.find(".checkin").parent().modal("hide").remove();
				Global.bimServerApi.unregisterProgressHandler(topicId, othis.progressHandler, successFunction);
			} else if (state.state == "STARTED" || state.state == "NONE") {
			}
		}
	};
	
	this.updateSubmitButton = function() {
        if (containerDiv.find(".deserializerName").val() != "[NONE]" && fileselected) {
        	containerDiv.find(".uploadButton").show();
        } else {
        	containerDiv.find(".uploadButton").hide();
        }
	}
	
	containerDiv.find(".deserializerName").change(othis.updateSubmitButton);
	
	containerDiv.find(".fileupload").fileupload({
		dataType: "json",
        url: Global.bimServerApi.baseUrl + '/upload',
		replaceFileInput: false,
		submit: function(e, data){
			if (!shouldsend) {
				shouldsend = false;
		        submitdata = data;
		        othis.updateSubmitButton();
				if (containerDiv.find(".comment").attr("value") == "" || containerDiv.find("#comment").attr("value") == lastVal) {
					var path = null;
					$.each(data.files, function (index, file) {
						path = file.name;
				    });
					if (path.indexOf("/") != -1) {
						path = path.substr(path.lastIndexOf("/") + 1);
					} else if (path.indexOf("\\") != -1) {
						path = path.substr(path.lastIndexOf("\\") + 1);
					}
					containerDiv.find(".comment").attr("value", path);
					lastVal = path;
				}
		        return false;
			}
        },
        change: function(e, data) {
        	fileselected = true;
        	var path = null;
			$.each(data.files, function (index, file) {
				path = file.name;
		    });
		    var lastIndex = path.lastIndexOf(".");
		    if (lastIndex != -1) {
			    var extension = path.substring(path.lastIndexOf(".") + 1);
			    Global.bimServerApi.call("ServiceInterface", "getSuggestedDeserializerForExtension", {extension: extension}, function(data){
			    	containerDiv.find(".deserializerName").val(data.oid);
					othis.updateSubmitButton();
				});
		    }
        },
		progress: function(e, data) {
			containerDiv.find(".uploadProgressBar .bar").css("width", parseInt(data.loaded / data.total * 100, 10) + "%");
		},
		done: function(e, data) {
			if (data.result.exception == null) {
				currentCheckinId = data.result.checkinid;
				containerDiv.find(".progressBarHolder .uploadProgressBar").remove();
				containerDiv.find(".progressBarHolder").append("<div class=\"uploadProgressBar progress\"><div class=\"bar\"></div></div>");
				Global.bimServerApi.registerProgressHandler(currentCheckinId, othis.progressHandler);
			} else {
				containerDiv.find(".uploadStatus").html("<div class=\"alert alert-block alert-error\">" + data.result.exception.message + "</div>");
				othis.showUpload();
			}
		},
		fail: function(e, data) {
			containerDiv.find(".uploadStatus").html("Error: " + data.textStatus);
			othis.showUpload();
		}
    });

	containerDiv.find(".uploadButton").click(function(event){
		shouldsend = true;
		submitdata.formData = {
			token: Global.bimServerApi.token,
			deserializerOid: containerDiv.find(".deserializerName").val(),
			comment: containerDiv.find(".comment").val(),
			merge: containerDiv.find(".merge").is(':checked'),
			poid: othis.project.oid
		};
		othis.hideUpload();
		containerDiv.find(".uploadStatus").html("Uploading file...");
		containerDiv.find(".progressBarHolder .uploadProgressBar").remove();
		containerDiv.find(".progressBarHolder").append("<div class=\"uploadProgressBar progress\"><div class=\"bar\"></div></div>");
		containerDiv.find(".fileupload").fileupload('send', submitdata);
		shouldsend = false;
		event.preventDefault();
	});

	containerDiv.find(".uploadbranch").hide();
	containerDiv.find(".uploadbranchlink").click(function(event){
		event.preventDefault();
		containerDiv.find(".upload").hide();
		containerDiv.find(".showuploadlink").show();
		containerDiv.find(".uploadbranch").show();
		containerDiv.find(".uploadbranchlink").hide();
		containerDiv.find(".uploadButton").html("Checkin existing revision");
	});
	containerDiv.find(".showuploadlink").hide();
	containerDiv.find(".showuploadlink").click(function(event){
		event.preventDefault();
		containerDiv.find(".upload").show();
		containerDiv.find(".showuploadlink").hide();
		containerDiv.find(".uploadbranch").hide();
		containerDiv.find(".uploadbranchlink").show();
		containerDiv.find(".uploadButton").html("Checkin new revision");
	});
	
	containerDiv.find(".uploadButton").hide();
	if (othis.project.subProjects.length != 0) {
		containerDiv.find(".uploadlink").show();
		containerDiv.find(".uploadlink").click(function(){
			containerDiv.find(".uploads").show();
			containerDiv.find(".uploadlink").hide();
		});
		containerDiv.find(".uploads").hide();
	} else {
		containerDiv.find(".uploads").show();
		containerDiv.find(".uploadlink").hide();
	}
}
</script>