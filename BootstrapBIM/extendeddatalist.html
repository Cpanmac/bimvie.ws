<div class="extendeddatalist">
	<div class="well well-small noextendeddata">
		No extended data
	</div>
	<table class="table initialhide table-striped table-hover">
		<thead>
			<tr>
				<th>Title</th>
				<th>Added</th>
				<th>User</th>
				<th>Schema</th>
				<th>Size</th>
				<th>Actions</th>
			</tr>
		</thead>
		<tbody>
		</tbody>
	</table>
</div>
<script>
function ExtendedDataList(main, revision) {
	var othis = this;

	bimServerApi.register("NotificationInterface", "newLogAction", othis.newLogAction);
	
	this.userClick = function(event){
		if (!$(event.target).is("a, button, span.caret")) {
			main.showUser($(this).data("user"), event);
			othis.close();
		}
	};
	
	this.extendedDataClick = function(event) {
		if (!$(event.target).is("a, button, span.caret")) {
			event.preventDefault();
			var extendedData = $(this).parents("tr").andSelf().data("extendeddata");
			console.log(extendedData);
			$(".extendeddatalist").load("extendeddata.html", function(){
				new ExtendedData(main, extendedData);
			});
		}
	};
	
	this.schemaLinkClick = function(event) {
	};
	
	this.makeSchemaLink = function(soid){
		var link = $("<a>Loading...</a>");
		link.attr("soid", soid);
		link.click(othis.schemaLinkClick);
		loadExtendedDataSchema(link);
		return link;
	};
	
	this.newLogAction = function(uuid, logAction, serviceIdentifier, profileIdentifier, token, apiUrl){
		if (logAction.__type == "SExtendedDataAddedToRevision") {
			bimServerApi.call("ServiceInterface", "getExtendedData", {oid: logAction.extendedDataId}, function(data){
				othis.addExtendedData(data);
			});
		}
	};
	
	this.addExtendedData = function(extendedData) {
		$(".extendeddatalist table").show();
		$(".extendeddatalist .noextendeddata").hide();
		var tr = $("<tr>");
		tr.click(othis.extendedDataClick);
		tr.data("extendeddata", extendedData);
		
		tr.append("<td>" + extendedData.title + "</td>");
		
		tr.append("<td><span title=\"" + formatDateTime(new Date(extendedData.added)) + "\" class=\"timespan\" datetime=\"" + extendedData.added + "\">" + formatTimeSpan(new Date().getTime() - extendedData.added, false) + "</span></td>");
		
		var userTd = $("<td></td>");
		var userA = $("<a>loading...</a>");
		userA.attr("uoid", extendedData.userId);
		userA.click(othis.userClick);
		userTd.append(userA);
		loadUser(userA);
		tr.append(userTd);
		
		var schemaTd = $("<td>");
		schemaTd.append(othis.makeSchemaLink(extendedData.schemaId));
		tr.append(schemaTd);
		tr.append("<td>" + GetHumanSize(extendedData.size) + "</td>");
		
		tr.append(newButtonTd("Download", othis.download));
		
		$(".extendeddatalist table tbody").append(tr);
	};
	
	this.download = function(event) {
		var extendedData = $(this).parents("tr").data("extendeddata");
		document.location = bimServerApi.generateExtendedDataDownloadUrl(extendedData.oid);
	};
	
	this.loadExtendedData = function() {
		bimServerApi.call("ServiceInterface", "getAllExtendedDataOfRevision", {roid: revision.oid}, function(data){
			data.forEach(function(extendedData){
				othis.addExtendedData(extendedData);
			});
		});
	};
	
	this.close = function(){
		bimServerApi.unregister(othis.newLogAction);
	};
	
	othis.loadExtendedData();
}
</script>