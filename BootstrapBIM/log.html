<div class="log">
	<table class="table table-striped">
		<thead>
			<tr>
				<th>Id</th>
				<th>Start</th>
				<th>End</th>
				<th>Title</th>
				<th>State</th>
				<th>Progress</th>
			</tr>
		</thead>
		<tbody></tbody>
	</table>
</div>
<script>
function Log(containerDiv, main, poid, roid) {
	var othis = this;
	
	this.close = function(){
		Global.bimServerApi.unregisterChangeProgressProjectHandler(othis.newChangeProgressHandler, othis.closedChangeProgressHandler);
	};
	
	this.progressHandler = function(topicId, state){
		var tr = containerDiv.find("table tr[tid=\"" + topicId + "\"]");
		if (tr.length == 0) {
			tr = $("<tr>");
			tr.attr("tid", topicId);
			tr.append("<td class=\"id\"></td>");
			tr.append("<td class=\"start\"></td>");
			tr.append("<td class=\"end\"></td>");
			tr.append("<td class=\"title\"></td>");
			tr.append("<td class=\"state\"></td>");
			tr.append("<td class=\"progresstd\" width=\"200px\"><div class=\"progress\"><div class=\"bar\"></div></div></td>");
			containerDiv.find("table tbody").append(tr);
			containerDiv.find("table tbody tr").sort(function(a, b){
				return parseInt($(a).attr("tid")) < parseInt($(b).attr("tid"));
			}).appendTo(containerDiv.find("table tbody"));
		}
		tr.find(".start").html(formatDateTime(new Date(state.start)));
		tr.find(".end").html(state.end != null ? formatDateTime(new Date(state.end)) : "");
		tr.find(".title").html(state.title);
		tr.find(".id").html(topicId);
		tr.find(".state").html(state.state);
		if (state.progress == -1) {
			if (state.state != "FINISHED") {
				tr.find(".progress").addClass("progress-striped").addClass("active");
				tr.find(".progress .bar").css("width", "100%");
			} else {
				tr.find(".progress .bar").css("width", "100%");
				tr.find(".progress").removeClass("progress-striped").removeClass("active");
			}
		} else if (state.progress == 100) {
			tr.find(".progress").hide();
		} else {
			tr.find(".progress .bar").css("width", state.progress + "%");
		}
	};

	this.newChangeProgressHandler = function(poid, topicId){
		Global.bimServerApi.call("RegistryInterface", "getProgress", {topicId: topicId}, function(state){
			othis.progressHandler(topicId, state);
			Global.bimServerApi.registerProgressHandler(topicId, othis.progressHandler);
		});
	};
	
	this.closedChangeProgressHandler = function(poid, topicId){
		Global.bimServerApi.unregisterProgressHandler(topicId, othis.progressHandler);
	};
	
	Global.bimServerApi.call("RegistryInterface", "getProgressTopicsOnProject", {poid: poid}, function(topicIds){
		topicIds.forEach(function(topicId){
			othis.newChangeProgressHandler(poid, topicId);
		});
		Global.bimServerApi.registerChangeProgressProjectHandler(poid, othis.newChangeProgressHandler, othis.closedChangeProgressHandler);
	});
}
</script>