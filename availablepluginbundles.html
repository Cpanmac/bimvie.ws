<div class="availablepluginbundles">
	<h3>Available Plugin Bundles <a class="helpBtn" title="Help"><span class="glyphicon glyphicon-question-sign"></span></a></h3>
	<div class="panel panel-default helpDiv ih">
  		<div class="panel-body">
			<p>Only plugin bundles are shown that have no installed versions on this BIMserver. To update installed plugins, goto <a class="installedPluginsBtn">Installed Plugin Bundles</a>.</p>
			<p>Plugins are discovered by connecting to a repository, you can change the repository in <a class="btnServerSettings">Server Settings</a></p>.
		</div>
	</div>
	<table class="table">
		<thead>
			<tr><th>Organization</th><th>Name</th><th>Description</th><th>Version</th><th>Install</th></tr>
		</thead>
		<tbody></tbody>
	</table>
</div>
<script>
function AvailablePluginBundles(main, serverSettings, cd) {
	var o = this;
	
	this.show = function(){};
	this.hide = function(){};
	
	Global.bimServerApi.callWithFullIndication("PluginInterface", "getAvailablePlugins", {}, function(data){
		cd.find("table tbody tr").remove();
		data.forEach(function(plugin){
			var tr = $("<tr>");
			
			var latest = plugin.latestVersion;
			
			tr.append("<td>" + plugin.organization + "</td>");
			tr.append("<td>" + plugin.name + "</td>");
			tr.append("<td>" + latest.description + "</td>");
			
			var versionTd = $("<td>");
			var versionSelect = $("<select class=\"form-control\">");
			versionTd.append(versionSelect);
			plugin.availableVersions.forEach(function(version){
				var text = version.version;
				if (version.version == latest.version) {
					text += " (latest)";
				}
				if (version.mismatch) {
					text += " (UNTESTED)";
				}
				var option = $("<option val=\"" + version.version + "\">" + text + "</option>");
				option.data("version", version);
				versionSelect.prepend(option);
				versionSelect.change(function(){
					tr.data("version", $(this).data("version"));
				});
			});
			
			tr.data("plugin", plugin);
			tr.data("version", plugin.latestVersion);
			
			tr.append(versionTd);

			var installTd = $("<td>");
			var installBtn = $("<button class=\"btn btn-primary\">Install</button>");
			installBtn.click(function(){
				var tr = $(this).parents("tr");
				var plugin = tr.data("plugin");
				var version = tr.data("version");
				serverSettings.showInstallPlugin(plugin, version);
			});
			installTd.append(installBtn);
			tr.append(installTd);

			cd.find("table tbody").append(tr);
		});
	});
	
	cd.find(".helpBtn").click(function(){
		cd.find(".helpDiv").toggle();
	});
	
	cd.find(".installedPluginsBtn").click(serverSettings.showInstalledPluginBundles);
	cd.find(".btnServerSettings").click(serverSettings.showBasicServerSettings);
}
</script>